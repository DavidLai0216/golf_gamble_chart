<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â›³ é«˜çƒåšå¼ˆå°ˆæ¥­ç‰ˆ</title>
    <style>
        :root { --primary: #2e7d32; --secondary: #f5f5f5; --accent: #ef6c00; --win: #d32f2f; --lose: #1976d2; }
        body { font-family: -apple-system, sans-serif; background: #eaeff2; margin: 0; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h2 { color: var(--primary); font-size: 1.1rem; border-left: 5px solid var(--primary); padding-left: 10px; margin-top: 0; }
        
        /* è¨­å®šé é¢ */
        .config-box { background: #f9f9f9; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .player-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .player-inputs input { width: 100%; padding: 10px 5px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 14px; box-sizing: border-box; }
        .pair-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; margin-top: 5px; }
        .btn-confirm { background: var(--primary); color: white; border: none; width: 100%; padding: 18px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        /* æˆç¸¾å¡é é¢ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { border: 1px solid #eee; padding: 8px 4px; text-align: center; }
        th { background: var(--primary); color: white; font-size: 13px; }
        .score-box { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        input[type="number"] { width: 45px; height: 35px; border: 1px solid #bbb; border-radius: 5px; text-align: center; font-size: 16px; }
        .hdcp-btn { font-size: 11px; background: #eee; border: 1px solid #ccc; border-radius: 4px; padding: 4px; cursor: pointer; width: 45px; }
        .hdcp-btn.active { background: var(--accent); color: white; border-color: #e65100; }

        /* çµç®— */
        .sum-val { font-weight: bold; font-size: 15px; }
        .val-win { color: var(--win); }
        .val-lose { color: var(--lose); }
    </style>
</head>
<body>

<div id="setupPage" class="card">
    <h2>1. ç¢ºèªçƒå“¡åç¨±</h2>
    <div class="player-inputs">
        <input type="text" id="p0" value="çƒå“¡A">
        <input type="text" id="p1" value="çƒå“¡B">
        <input type="text" id="p2" value="çƒå“¡C">
        <input type="text" id="p3" value="çƒå“¡D">
    </div>

    <h2>2. é¸æ“‡éŠæˆ²èˆ‡åˆ†çµ„åƒæ•¸</h2>
    
    <div class="config-box">
        <label style="font-weight: bold;"><input type="checkbox" id="chkLvg" checked> æ‹‰æ–¯ç¶­åŠ æ–¯ (Las Vegas)</label>
        <div style="margin-left: 22px; font-size: 14px; color: #555; margin-top: 8px;">
            <label><input type="checkbox" id="lvgFlip" checked> æŠ“é³¥ç¿»ç‰Œ</label><br>
            åˆ†çµ„æ¨¡å¼ï¼š<select id="lvgPair" class="pair-select">
                <option value="fixed">ç¬¬ä¸€çµ„å›ºå®š (A + B)</option>
                <option value="6">æ¯ 6 æ´æ›æ­æª”</option>
                <option value="9">æ¯ 9 æ´æ›æ­æª”</option>
            </select>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight: bold;"><input type="checkbox" id="chkBest"> å››äººå››çƒ (Best Ball)</label>
        <div style="margin-left: 22px; font-size: 14px; color: #555; margin-top: 8px;">
            ç¬¬ä¸€çµ„æˆå“¡ï¼š
            <select id="bestP1" class="pair-select"><option value="0">çƒå“¡A</option></select> + 
            <select id="bestP2" class="pair-select">
                <option value="1">çƒå“¡B</option>
                <option value="2">çƒå“¡C</option>
                <option value="3">çƒå“¡D</option>
            </select>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight: bold;"><input type="checkbox" id="chkSkins"> Skins (å²ä¼°åƒå¹¾)</label>
        <div style="margin-left: 22px; font-size: 14px; color: #555; margin-top: 8px;">
            <label><input type="checkbox" id="skinCarry" checked> å¹³æ‰‹ç´¯ç© (Carry Over)</label><br>
            é©—è­‰é–€æª»ï¼š<select id="skinVal" class="pair-select">
                <option value="4">Par (4æ¡¿)</option>
                <option value="5">Bogey (5æ¡¿)</option>
                <option value="99">ä¸é©—è­‰</option>
            </select>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight: bold;"><input type="checkbox" id="chkScratch" checked> Scratch (ç¸½æ¡¿/è®“æ¡¿æ¯”æ¡¿)</label>
    </div>

    <button class="btn-confirm" onclick="initGame()">ç¢ºèªè¨­å®šï¼Œé–‹å§‹æ“Šçƒ â›³</button>
</div>

<div id="gamePage" class="hidden">
    <div class="card" style="padding: 5px;">
        <div class="table-wrapper">
            <table>
                <thead><tr id="tHead"><th>æ´</th><th>A</th><th>B</th><th>C</th><th>D</th></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° å³æ™‚çµç®—ç¸½è¦½</h2>
        <table>
            <thead><tr><th>çƒå“¡</th><th>æ‹‰æ–¯</th><th>Skins</th><th>BestBall</th><th>ç¸½æ¡¿</th></tr></thead>
            <tbody id="sumBody"></tbody>
        </table>
    </div>

    <button onclick="location.reload()" style="width:100%; padding:12px; background:#999; color:white; border:none; border-radius:8px;">é‡æ–°è¨­å®š</button>
</div>

<script>
    let g = {}; // éŠæˆ²è¨­å®šå­˜å„²

    function initGame() {
        g = {
            names: [0, 1, 2, 3].map(i => document.getElementById('p' + i).value),
            lvg: document.getElementById('chkLvg').checked,
            lvgFlip: document.getElementById('lvgFlip').checked,
            lvgPair: document.getElementById('lvgPair').value,
            best: document.getElementById('chkBest').checked,
            bestP1: 0,
            bestP2: parseInt(document.getElementById('bestP2').value),
            skins: document.getElementById('chkSkins').checked,
            skinCarry: document.getElementById('skinCarry').checked,
            skinVal: parseInt(document.getElementById('skinVal').value),
            scratch: document.getElementById('chkScratch').checked
        };

        // æ›´æ–°è¡¨é ­
        let headHtml = '<th>æ´</th>';
        g.names.forEach(n => headHtml += `<th>${n}</th>`);
        document.getElementById('tHead').innerHTML = headHtml;

        // ç”Ÿæˆè¡¨æ ¼
        const body = document.getElementById('tBody');
        body.innerHTML = '';
        for (let h = 1; h <= 18; h++) {
            const tr = document.createElement('tr');
            let rows = `<td><b>${h}</b></td>`;
            for (let p = 0; p < 4; p++) {
                rows += `<td>
                    <div class="score-box">
                        <input type="number" class="score-in" data-h="${h}" data-p="${p}" oninput="runCalc()">
                        <button class="hdcp-btn" onclick="this.classList.toggle('active'); runCalc();">è®“</button>
                    </div>
                </td>`;
            }
            tr.innerHTML = rows;
            body.appendChild(tr);
        }

        document.getElementById('setupPage').classList.add('hidden');
        document.getElementById('gamePage').classList.remove('hidden');
        runCalc();
    }

    function runCalc() {
        let res = [0, 1, 2, 3].map(() => ({ lvg: 0, skin: 0, bb: 0, sc: 0 }));
        let skinPool = 0;

        for (let h = 1; h <= 18; h++) {
            let sRaw = [], sFinal = [], valid = true;
            for (let p = 0; p < 4; p++) {
                let input = document.querySelector(`.score-in[data-h="${h}"][data-p="${p}"]`);
                let isH = input.nextElementSibling.classList.contains('active');
                if (input.value === "") { valid = false; break; }
                let val = parseInt(input.value);
                sRaw.push(val);
                sFinal.push(val - (isH ? 1 : 0)); // è®“æ¡¿é‚è¼¯ï¼šå…¨éƒ¨éŠæˆ²é€šç”¨
            }
            if (!valid) continue;

            // 1. Scratch (æ¯”ç¸½æ¡¿)
            sRaw.forEach((v, i) => res[i].sc += v);

            // 2. æ‹‰æ–¯ç¶­åŠ æ–¯ (å«ä¸²è¯èˆ‡ç¿»ç‰Œ)
            if (g.lvg) {
                let pIdx;
                if (g.lvgPair === 'fixed' || h <= parseInt(g.lvgPair)) pIdx = [0, 1, 2, 3];
                else if (h <= parseInt(g.lvgPair)*2) pIdx = [0, 2, 1, 3];
                else pIdx = [0, 3, 1, 2];

                let vA = Math.min(sFinal[pIdx[0]], sFinal[pIdx[1]])*10 + Math.max(sFinal[pIdx[0]], sFinal[pIdx[1]]);
                let vB = Math.min(sFinal[pIdx[2]], sFinal[pIdx[3]])*10 + Math.max(sFinal[pIdx[2]], sFinal[pIdx[3]]);
                
                if (g.lvgFlip) {
                    if (vA < vB && (sFinal[pIdx[0]] <= 3 || sFinal[pIdx[1]] <= 3)) vB = (vB%10)*10 + Math.floor(vB/10);
                    else if (vB < vA && (sFinal[pIdx[2]] <= 3 || sFinal[pIdx[3]] <= 3)) vA = (vA%10)*10 + Math.floor(vA/10);
                }
                let diff = vB - vA;
                res[pIdx[0]].lvg += diff; res[pIdx[1]].lvg += diff;
                res[pIdx[2]].lvg -= diff; res[pIdx[3]].lvg -= diff;
            }

            // 3. Skins
            if (g.skins) {
                skinPool += 1;
                let min = Math.min(...sFinal);
                let wins = sFinal.map((s, i) => s === min ? i : -1).filter(i => i !== -1);
                if (wins.length === 1 && sFinal[wins[0]] <= g.skinVal) {
                    res[wins[0]].skin += skinPool; skinPool = 0;
                } else if (!g.skinCarry) { skinPool = 0; }
            }

            // 4. å››äººå››çƒ (Best Ball)
            if (g.best) {
                let team1 = [g.bestP1, g.bestP2];
                let team2 = [0, 1, 2, 3].filter(i => !team1.includes(i));
                let b1 = Math.min(sFinal[team1[0]], sFinal[team1[1]]);
                let b2 = Math.min(sFinal[team2[0]], sFinal[team2[1]]);
                if (b1 < b2) { res[team1[0]].bb++; res[team1[1]].bb++; }
                else if (b2 < b1) { res[team2[0]].bb++; res[team2[1]].bb++; }
            }
        }

        const sum = document.getElementById('sumBody');
        sum.innerHTML = g.names.map((n, i) => `
            <tr class="sum-val">
                <td>${n}</td>
                <td class="${res[i].lvg >= 0 ? 'val-win' : 'val-lose'}">${res[i].lvg}</td>
                <td class="val-win">${res[i].skin}</td>
                <td class="val-win">${res[i].bb}</td>
                <td>${res[i].sc}</td>
            </tr>`).join('');
    }
</script>
</body>
</html>
