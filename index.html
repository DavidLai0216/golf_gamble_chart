<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â›³ é«˜çƒåšå¼ˆå°ˆæ¥­è¨­å®šç‰ˆ</title>
    <style>
        :root { --primary: #1b5e20; --bg: #f0f4f7; --accent: #ef6c00; --win: #d32f2f; --lose: #1976d2; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; font-size: 14px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h2 { color: var(--primary); font-size: 1.1rem; border-left: 5px solid var(--primary); padding-left: 10px; margin-top: 0; margin-bottom: 15px; }
        .config-box { background: #f9f9f9; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .player-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .player-inputs input { width: 100%; padding: 10px 5px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-weight: bold; box-sizing: border-box; }
        select, button.setup-btn { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .btn-confirm { background: var(--primary); color: white; border: none; width: 100%; padding: 18px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid #eee; padding: 6px; text-align: center; }
        th { background: var(--primary); color: white; }
        input[type="number"] { width: 50px; height: 35px; border: 1px solid #bbb; border-radius: 5px; text-align: center; font-size: 16px; }
        .hdcp-mark { color: var(--accent); font-weight: bold; font-size: 12px; display: block; }
        
        /* è®“æ¡¿é è¨­è¡¨æ¨£å¼ */
        .hdcp-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; font-size: 10px; text-align: center; }
        .hdcp-cell { border: 1px solid #ddd; padding: 2px; }

        /* çµç®— */
        .val-win { color: var(--win); font-weight: bold; }
        .val-lose { color: var(--lose); font-weight: bold; }
    </style>
</head>
<body>

<div id="setupPage" class="card">
    <h2>1. ç¢ºèªçƒå“¡åç¨± (è«‹å…ˆè¼¸å…¥)</h2>
    <div class="player-inputs">
        <input type="text" id="p0" value="å¤§æœªä¾†" oninput="syncNames()">
        <input type="text" id="p1" value="å°æ˜Ÿæ˜Ÿ" oninput="syncNames()">
        <input type="text" id="p2" value="Teresa" oninput="syncNames()">
        <input type="text" id="p3" value="ç§€ç§€" oninput="syncNames()">
    </div>

    <h2>2. éŠæˆ²åˆ†çµ„èˆ‡åƒæ•¸è¨­å®š</h2>
    
    <div class="config-box">
        <label style="font-weight:bold;"><input type="checkbox" id="chkLvg" checked> æ‹‰æ–¯ç¶­åŠ æ–¯ (Las Vegas)</label>
        <div style="margin: 10px 0 0 20px;">
            <label><input type="checkbox" id="lvgFlip" checked> æŠ“é³¥ç¿»ç‰Œ</label><br>
            åˆ†çµ„é‚è¼¯ï¼š<select id="lvgMode" onchange="toggleManualPair()">
                <option value="6">æ¯ 6 æ´æ›éšŠ (è‡ªå‹•)</option>
                <option value="9">æ¯ 9 æ´æ›éšŠ (è‡ªå‹•)</option>
                <option value="manual">æ‰‹å‹•è¨­å®šåˆ†çµ„</option>
            </select>
            <div id="manualPairing" class="hidden" style="margin-top:5px; background:#fff; padding:5px; border:1px dashed #ccc;">
                1-6æ´: <span class="n0">A</span>+<span class="n1">B</span> vs <span class="n2">C</span>+<span class="n3">D</span><br>
                7-12æ´: <span class="n0">A</span>+<span class="n2">C</span> vs <span class="n1">B</span>+<span class="n3">D</span><br>
                13-18æ´: <span class="n0">A</span>+<span class="n3">D</span> vs <span class="n1">B</span>+<span class="n2">C</span>
            </div>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight:bold;"><input type="checkbox" id="chkBest"> å››äººå››çƒ (Best Ball)</label>
        <div style="margin: 10px 0 0 20px;">
            éšŠä¼ä¸€ï¼š<select id="bestT1_1" class="n-select"></select> + <select id="bestT1_2" class="n-select"></select>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight:bold;"><input type="checkbox" id="chkSkins"> Skins (æ–¯é‡‘èŒ²)</label>
        <div style="margin: 10px 0 0 20px;">
            <label><input type="checkbox" id="sCarry" checked> å¹³æ‰‹ç´¯ç© (Carry Over)</label><br>
            é©—è­‰é–€æª»ï¼š<select id="sVal"><option value="4">Par</option><option value="5">Bogey</option><option value="99">ä¸é©—è­‰</option></select>
        </div>
    </div>

    <div class="config-box">
        <label style="font-weight:bold;"><input type="checkbox" id="chkScr"> Scratch (å²ä¼°åƒå¹¾)</label>
        <div style="margin: 10px 0 0 20px;">
            æ¨¡å¼ï¼š<select id="scrMode">
                <option value="all">å…¨éƒ¨å°æ±º (Full Duel)</option>
                <option value="single">å–®æŒ‘ (éœ€å¦é¸å°è±¡)</option>
            </select>
        </div>
    </div>

    <h2>3. é è¨­è®“æ¡¿æ´ (ç›´æ¥å‹¾é¸)</h2>
    <div id="hdcpPreSet"></div>

    <button class="btn-confirm" onclick="startApp()">è¨­å®šå®Œæˆï¼Œé€²å…¥æˆç¸¾å¡ â›³</button>
</div>

<div id="gamePage" class="hidden">
    <div class="card" style="padding: 5px;">
        <div class="table-wrapper">
            <table>
                <thead><tr id="tHead"></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° å³æ™‚çµç®—ç¸½è¦½</h2>
        <table>
            <thead><tr><th>çƒå“¡</th><th>æ‹‰æ–¯</th><th>Skins</th><th>å››äººå››çƒ</th><th>å²ä¼°åƒå¹¾</th><th>ç¸½æ¡¿</th></tr></thead>
            <tbody id="sumBody"></tbody>
        </table>
    </div>
    <button onclick="location.reload()" style="width:100%; background:#999; color:white; border:none; padding:10px; border-radius:8px;">è¿”å›é‡æ–°è¨­å®š</button>
</div>

<script>
    let players = [];
    let hdcpMap = {};

    function syncNames() {
        players = [0,1,2,3].map(i => document.getElementById('p'+i).value);
        document.querySelectorAll('.n0').forEach(e => e.innerText = players[0]);
        document.querySelectorAll('.n1').forEach(e => e.innerText = players[1]);
        document.querySelectorAll('.n2').forEach(e => e.innerText = players[2]);
        document.querySelectorAll('.n3').forEach(e => e.innerText = players[3]);
        
        // æ›´æ–° Best Ball ä¸‹æ‹‰é¸å–®
        const selects = document.querySelectorAll('.n-select');
        selects.forEach((sel, i) => {
            const currentVal = sel.value;
            sel.innerHTML = players.map((n, idx) => `<option value="${idx}">${n}</option>`).join('');
            if (currentVal !== "") sel.value = currentVal;
            else if (sel.id === "bestT1_1") sel.value = 0;
            else if (sel.id === "bestT1_2") sel.value = 1;
        });
    }

    function renderHdcpGrid() {
        let html = '<div class="hdcp-grid">';
        for (let p = 0; p < 4; p++) {
            html += `<div style="grid-column: span 10; background:#eee; font-weight:bold; margin-top:5px;">${players[p]} çš„å—è®“æ´</div>`;
            for (let h = 1; h <= 18; h++) {
                html += `<div class="hdcp-cell">${h}<br><input type="checkbox" class="h-check" data-p="${p}" data-h="${h}"></div>`;
            }
        }
        html += '</div>';
        document.getElementById('hdcpPreSet').innerHTML = html;
    }

    function toggleManualPair() {
        const mode = document.getElementById('lvgMode').value;
        document.getElementById('manualPairing').classList.toggle('hidden', mode !== 'manual');
    }

    function startApp() {
        // ç´€éŒ„è®“æ¡¿è¨­å®š
        hdcpMap = {};
        document.querySelectorAll('.h-check:checked').forEach(ck => {
            const p = ck.getAttribute('data-p'), h = ck.getAttribute('data-h');
            if(!hdcpMap[h]) hdcpMap[h] = {};
            hdcpMap[h][p] = true;
        });

        // ç”Ÿæˆè¡¨é ­
        let headHtml = '<th>æ´</th>';
        players.forEach(n => headHtml += `<th>${n}</th>`);
        document.getElementById('tHead').innerHTML = headHtml;

        // ç”Ÿæˆ 18 æ´
        const body = document.getElementById('tBody');
        body.innerHTML = '';
        for (let h = 1; h <= 18; h++) {
            const tr = document.createElement('tr');
            let cols = `<td><b>${h}</b></td>`;
            for (let p = 0; p < 4; p++) {
                const isH = (hdcpMap[h] && hdcpMap[h][p]) ? '<span class="hdcp-mark">è®“</span>' : '';
                cols += `<td><input type="number" class="s-in" data-h="${h}" data-p="${p}" oninput="calc()"> ${isH}</td>`;
            }
            tr.innerHTML = cols;
            body.appendChild(tr);
        }

        document.getElementById('setupPage').classList.add('hidden');
        document.getElementById('gamePage').classList.remove('hidden');
        calc();
    }

    function calc() {
        const conf = {
            lvg: document.getElementById('chkLvg').checked,
            lvgMode: document.getElementById('lvgMode').value,
            lvgFlip: document.getElementById('lvgFlip').checked,
            best: document.getElementById('chkBest').checked,
            bestT1: [parseInt(document.getElementById('bestT1_1').value), parseInt(document.getElementById('bestT1_2').value)],
            skins: document.getElementById('chkSkins').checked,
            sCarry: document.getElementById('sCarry').checked,
            sVal: parseInt(document.getElementById('sVal').value),
            scr: document.getElementById('chkScr').checked,
            scrMode: document.getElementById('scrMode').value
        };

        let res = [0,1,2,3].map(() => ({ vegas: 0, skins: 0, best: 0, scillag: 0, total: 0 }));
        let skinPool = 0;

        for (let h = 1; h <= 18; h++) {
            let sRaw = [], sNet = [], valid = true;
            for (let p = 0; p < 4; p++) {
                let v = document.querySelector(`.s-in[data-h="${h}"][data-p="${p}"]`).value;
                if (v === "") { valid = false; break; }
                let score = parseInt(v);
                sRaw.push(score);
                sNet.push(score - ((hdcpMap[h] && hdcpMap[h][p]) ? 1 : 0));
            }
            if (!valid) continue;

            // ç¸½æ¡¿ç´¯è¨ˆ
            sRaw.forEach((v, i) => res[i].total += v);

            // Las Vegas
            if (conf.lvg) {
                let pIdx;
                if (conf.lvgMode === "6") pIdx = (h<=6) ? [0,1,2,3] : (h<=12 ? [0,2,1,3] : [0,3,1,2]);
                else if (conf.lvgMode === "9") pIdx = (h<=9) ? [0,1,2,3] : [0,2,1,3];
                else pIdx = [0,1,2,3]; // é è¨­æ‰‹å‹•çš„ç¬¬ä¸€ç¨®åˆ†çµ„

                let vA = Math.min(sNet[pIdx[0]], sNet[pIdx[1]])*10 + Math.max(sNet[pIdx[0]], sNet[pIdx[1]]);
                let vB = Math.min(sNet[pIdx[2]], sNet[pIdx[3]])*10 + Math.max(sNet[pIdx[2]], sNet[pIdx[3]]);
                if (conf.lvgFlip) {
                    if (vA < vB && [sNet[pIdx[0]], sNet[pIdx[1]]].some(s => s <= 3)) vB = (vB%10)*10 + Math.floor(vB/10);
                    else if (vB < vA && [sNet[pIdx[2]], sNet[pIdx[3]]].some(s => s <= 3)) vA = (vA%10)*10 + Math.floor(vA/10);
                }
                let diff = vB - vA;
                res[pIdx[0]].vegas += diff; res[pIdx[1]].vegas += diff; res[pIdx[2]].vegas -= diff; res[pIdx[3]].vegas -= diff;
            }

            // Skins
            if (conf.skins) {
                skinPool++;
                let min = Math.min(...sNet);
                let winners = sNet.map((s, i) => s === min ? i : -1).filter(i => i !== -1);
                if (winners.length === 1 && sNet[winners[0]] <= conf.sVal) {
                    res[winners[0]].skins += skinPool; skinPool = 0;
                } else if (!conf.sCarry) skinPool = 0;
            }

            // Four Ball
            if (conf.best) {
                const t1 = conf.bestT1, t2 = [0,1,2,3].filter(i => !t1.includes(i));
                let b1 = Math.min(sNet[t1[0]], sNet[t1[1]]), b2 = Math.min(sNet[t2[0]], sNet[t2[1]]);
                if (b1 < b2) { res[t1[0]].best++; res[t1[1]].best++; }
                else if (b2 < b1) { res[t2[0]].best++; res[t2[1]].best++; }
            }

            // Scillag (Scratch) - C4å–2 å…¨å°æ±ºé‚è¼¯
            if (conf.scr && conf.scrMode === "all") {
                for (let i = 0; i < 4; i++) {
                    for (let j = i + 1; j < 4; j++) {
                        if (sNet[i] < sNet[j]) { res[i].scillag++; res[j].scillag--; }
                        else if (sNet[j] < sNet[i]) { res[j].scillag++; res[i].scillag--; }
                    }
                }
            }
        }

        const sum = document.getElementById('sumBody');
        sum.innerHTML = players.map((n, i) => `<tr>
            <td>${n}</td>
            <td class="${res[i].vegas>=0?'val-win':'val-lose'}">${res[i].vegas}</td>
            <td class="val-win">${res[i].skins}</td>
            <td class="val-win">${res[i].best}</td>
            <td class="${res[i].scillag>=0?'val-win':'val-lose'}">${res[i].scillag}</td>
            <td>${res[i].total}</td>
        </tr>`).join('');
    }

    syncNames();
    renderHdcpGrid();
</script>
</body>
</html>
