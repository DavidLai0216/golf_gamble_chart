<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜çƒåšå¼ˆçµ‚æ¥µå®¢è£½ç‰ˆ</title>
    <style>
        :root { --primary: #1b5e20; --bg: #f0f4f7; --accent: #ef6c00; --win: #d32f2f; --lose: #1976d2; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; font-size: 14px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h2 { color: var(--primary); font-size: 1.1rem; border-left: 5px solid var(--primary); padding-left: 10px; margin: 0 0 15px 0; }
        .config-box { background: #f9f9f9; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .player-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .player-inputs input { width: 100%; padding: 10px 5px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-weight: bold; box-sizing: border-box; }
        select, input[type="text"].small-in { padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; }
        .btn-confirm { background: var(--primary); color: white; border: none; width: 100%; padding: 18px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid #eee; padding: 8px 4px; text-align: center; }
        th { background: var(--primary); color: white; font-size: 13px; }
        input[type="number"] { width: 60px; height: 35px; border: 1px solid #bbb; border-radius: 5px; text-align: center; font-size: 18px; font-weight: bold; }
        
        /* çµç®—æ¨£å¼ */
        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th { background: #455a64; color: white; padding: 8px; font-size: 12px; }
        .summary-table td { border: 1px solid #eee; padding: 12px 5px; text-align: center; font-weight: bold; }
        .val-win { color: var(--win); }
        .val-lose { color: var(--lose); }
        .duel-row { border-bottom: 1px solid #ddd; padding: 8px 0; }
        .lvg-pair-box { background: white; padding: 8px; border: 1px dashed #ccc; margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="setupPage" class="card">
    <h2>1. ç¢ºèªçƒå“¡å§“å</h2>
    <div class="player-inputs">
        <input type="text" id="p0" value="å¤§æœªä¾†" oninput="syncAll()">
        <input type="text" id="p1" value="å°æ˜Ÿæ˜Ÿ" oninput="syncAll()">
        <input type="text" id="p2" value="Teresa" oninput="syncAll()">
        <input type="text" id="p3" value="ç§€ç§€" oninput="syncAll()">
    </div>

    <h2>2. éŠæˆ²åƒæ•¸èˆ‡åˆ†çµ„è¨­å®š</h2>
    
    <div class="config-box">
        <label><input type="checkbox" id="chkLvg" checked> æ‹‰æ–¯ç¶­åŠ æ–¯ (Las Vegas)</label>
        <div style="margin-left:22px; margin-top:5px;">
            <label><input type="checkbox" id="lvgFlip" checked> å•Ÿç”¨æŠ“é³¥ç¿»ç‰Œ</label><br>
            åˆ†çµ„è¦å‰‡ï¼š<select id="lvgMode" onchange="toggleLvgPairs()">
                <option value="fixed">å›ºå®š (A+B vs C+D)</option>
                <option value="6">æ¯ 6 æ´æ›æ­æª” (æ‰‹å‹•æŒ‡å®š)</option>
                <option value="9">æ¯ 9 æ´æ›æ­æª” (æ‰‹å‹•æŒ‡å®š)</option>
            </select>
            <div id="lvgManualBox" class="hidden">
                <div id="lvgP1" class="lvg-pair-box"></div>
                <div id="lvgP2" class="lvg-pair-box"></div>
                <div id="lvgP3" class="lvg-pair-box"></div>
            </div>
        </div>
    </div>

    <div class="config-box">
        <label><input type="checkbox" id="chkBest" checked> å››äººå››çƒ (Best Ball)</label>
        <div style="margin-left:22px; margin-top:5px;">
            <label><input type="checkbox" id="bestCarry" checked> å¹³æ‰‹ç´¯ç© (Carry Over)</label><br>
            ç¬¬ä¸€çµ„ï¼š<select id="bestP1" class="n-sel"></select> + <select id="bestP2" class="n-sel"></select>
        </div>
    </div>

    <div class="config-box">
        <label><input type="checkbox" id="chkScr" checked> å²ä¼°åƒå¹¾ (Scratch)</label>
        <div style="margin-left:22px; margin-top:5px;">
            æ¨¡å¼ï¼š<select id="scrMode" onchange="toggleScrMode()">
                <option value="all">å…¨éƒ¨å°æ±º ($C_4^2$ å…­çµ„ PK)</option>
                <option value="manual">æ‰‹å‹•è¨­å®šå–®æŒ‘å°æ±º</option>
            </select>
            <div id="scrManualBox" class="hidden" style="margin-top:10px;">
                <div id="scrDuelList"></div>
            </div>
        </div>
    </div>

    <div class="config-box">
        <label><input type="checkbox" id="chkSkins" checked> Skins (æ–¯é‡‘èŒ²)</label>
        <div style="margin-left:22px; margin-top:5px;">
            <label><input type="checkbox" id="skinCarry" checked> å¹³æ‰‹ç´¯ç©</label> | 
            é–€æª»ï¼š<select id="skinVal"><option value="4">Par</option><option value="5">Bogey</option><option value="99">ä¸é©—è­‰</option></select>
        </div>
    </div>

    <button class="btn-confirm" onclick="startApp()">ç¢ºèªè¨­å®šï¼Œé–‹å§‹è¨˜éŒ„æˆç¸¾ â›³</button>
</div>

<div id="gamePage" class="hidden">
    <div class="card" style="padding: 5px;">
        <div class="table-wrapper">
            <table>
                <thead><tr id="tHead"></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° åˆ†é …ç´¯ç©å‹è² çµç®—</h2>
        <table class="summary-table">
            <thead><tr><th>çƒå“¡</th><th>æ‹‰æ–¯</th><th>å››çƒ</th><th>å²ä¼°</th><th>Skins</th><th>ç¸½æ¡¿</th></tr></thead>
            <tbody id="sumBody"></tbody>
        </table>
    </div>
    <button onclick="location.reload()" style="width:100%; padding:10px; background:#999; color:white; border:none; border-radius:8px;">é‡æ–°è¨­å®šéŠæˆ²</button>
</div>

<script>
    let players = [];
    
    // åˆå§‹åŒ–åŒæ­¥å§“å
    function syncAll() {
        players = [0,1,2,3].map(i => document.getElementById('p'+i).value);
        
        // åŒæ­¥æ‰€æœ‰ä¸‹æ‹‰é¸å–®
        document.querySelectorAll('.n-sel').forEach((sel, idx) => {
            const oldVal = sel.value;
            sel.innerHTML = players.map((name, i) => `<option value="${i}">${name}</option>`).join('');
            if (oldVal !== "") sel.value = oldVal;
            else if (sel.id === "bestP1") sel.value = 0;
            else if (sel.id === "bestP2") sel.value = 1;
        });

        toggleLvgPairs();
        renderScrDuels();
    }

    // æ‹‰æ–¯ç¶­åŠ æ–¯æ‰‹å‹•æ›éšŠé¸å–®
    function toggleLvgPairs() {
        const mode = document.getElementById('lvgMode').value;
        const box = document.getElementById('lvgManualBox');
        box.classList.toggle('hidden', mode === 'fixed');
        if (mode !== 'fixed') {
            const ranges = mode === "6" ? ["1-6æ´", "7-12æ´", "13-18æ´"] : ["1-9æ´", "10-18æ´"];
            ranges.forEach((label, i) => {
                const container = document.getElementById('lvgP' + (i+1));
                container.innerHTML = `${label}ï¼š<select class="lv-p1 n-sel-dyn"></select> + <select class="lv-p2 n-sel-dyn"></select> ç‚ºä¸€çµ„`;
                container.querySelectorAll('select').forEach((s, sIdx) => {
                    s.innerHTML = players.map((name, pIdx) => `<option value="${pIdx}">${name}</option>`).join('');
                    if (sIdx === 0) s.value = 0; else s.value = (i+1 < 4) ? i+1 : 1;
                });
            });
            for(let j=ranges.length+1; j<=3; j++) document.getElementById('lvgP'+j).innerHTML = '';
        }
    }

    // å²ä¼°åƒå¹¾æ‰‹å‹•å–®æŒ‘åˆ—è¡¨
    function toggleScrMode() {
        document.getElementById('scrManualBox').classList.toggle('hidden', document.getElementById('scrMode').value !== 'manual');
    }

    function renderScrDuels() {
        const list = document.getElementById('scrDuelList');
        if (list.children.length === 0) {
            let html = '';
            for (let i = 1; i <= 6; i++) {
                html += `<div class="duel-row">
                    <b>å°æ±º ${i}ï¼š</b> <select class="scr-p1 n-sel-dyn"></select> vs <select class="scr-p2 n-sel-dyn"></select><br>
                    èª°è®“èª°ï¼š<select class="scr-giver n-sel-dyn"></select> è®“ <select class="scr-rec n-sel-dyn"></select><br>
                    è®“æ¡¿æ´è™Ÿ (å¦‚ 1,3,9)ï¼š<input type="text" class="scr-h small-in" style="width:120px;" placeholder="æ‰‹å‹•è¼¸å…¥æ´è™Ÿ">
                </div>`;
            }
            list.innerHTML = html;
        }
        list.querySelectorAll('select.n-sel-dyn').forEach(sel => {
            const val = sel.value;
            sel.innerHTML = `<option value="-1">ä¸ä½¿ç”¨</option>` + players.map((name, i) => `<option value="${i}">${name}</option>`).join('');
            sel.value = (val !== "") ? val : -1;
        });
    }

    // é–‹å§‹éŠæˆ²
    function startApp() {
        let headHtml = '<th>æ´</th>';
        players.forEach(name => headHtml += `<th>${name}</th>`);
        document.getElementById('tHead').innerHTML = headHtml;

        const body = document.getElementById('tBody');
        body.innerHTML = '';
        for (let h = 1; h <= 18; h++) {
            const tr = document.createElement('tr');
            let cols = `<td><b>${h}</b></td>`;
            for (let p = 0; p < 4; p++) {
                cols += `<td><input type="number" class="score-in" data-h="${h}" data-p="${p}" oninput="calc()"></td>`;
            }
            tr.innerHTML = cols;
            body.appendChild(tr);
        }

        document.getElementById('setupPage').classList.add('hidden');
        document.getElementById('gamePage').classList.remove('hidden');
        calc();
    }

    // æ ¸å¿ƒè¨ˆç®—
    function calc() {
        const cfg = {
            lvg: document.getElementById('chkLvg').checked, lMode: document.getElementById('lvgMode').value, lFlip: document.getElementById('lvgFlip').checked,
            best: document.getElementById('chkBest').checked, bCarry: document.getElementById('bestCarry').checked, bT1: [parseInt(document.getElementById('bestP1').value), parseInt(document.getElementById('bestP2').value)],
            scr: document.getElementById('chkScr').checked, sMode: document.getElementById('scrMode').value,
            skin: document.getElementById('chkSkins').checked, skCarry: document.getElementById('skinCarry').checked, skVal: parseInt(document.getElementById('skinVal').value)
        };

        let res = [0,1,2,3].map(() => ({ vegas: 0, best: 0, scr: 0, skins: 0, total: 0 }));
        let bPool = 0, skPool = 0;

        for (let h = 1; h <= 18; h++) {
            let scores = [], valid = true;
            for (let p = 0; p < 4; p++) {
                let v = document.querySelector(`.score-in[data-h="${h}"][data-p="${p}"]`).value;
                if (v === "") { valid = false; break; }
                scores.push(parseInt(v));
            }
            if (!valid) continue;

            scores.forEach((s, i) => res[i].total += s);

            // 1. Las Vegas
            if (cfg.lvg) {
                let pIdx;
                if (cfg.lMode === 'fixed') pIdx = [0,1,2,3];
                else {
                    const bIdx = cfg.lMode === "6" ? Math.ceil(h/6) : Math.ceil(h/9);
                    const sel1 = document.querySelector(`#lvgP${bIdx} .lv-p1`).value;
                    const sel2 = document.querySelector(`#lvgP${bIdx} .lv-p2`).value;
                    const t1 = [parseInt(sel1), parseInt(sel2)];
                    const t2 = [0,1,2,3].filter(i => !t1.includes(i));
                    pIdx = [...t1, ...t2];
                }
                let vA = Math.min(scores[pIdx[0]], scores[pIdx[1]])*10 + Math.max(scores[pIdx[0]], scores[pIdx[1]]);
                let vB = Math.min(scores[pIdx[2]], scores[pIdx[3]])*10 + Math.max(scores[pIdx[2]], scores[pIdx[3]]);
                if (cfg.lFlip) {
                    if (vA < vB && [scores[pIdx[0]], scores[pIdx[1]]].some(s => s <= 3)) vB = (vB%10)*10 + Math.floor(vB/10);
                    else if (vB < vA && [scores[pIdx[2]], scores[pIdx[3]]].some(s => s <= 3)) vA = (vA%10)*10 + Math.floor(vA/10);
                }
                let diff = vB - vA;
                res[pIdx[0]].vegas += diff; res[pIdx[1]].vegas += diff; res[pIdx[2]].vegas -= diff; res[pIdx[3]].vegas -= diff;
            }

            // 2. Best Ball
            if (cfg.best) {
                bPool++;
                let t1 = cfg.bT1, t2 = [0,1,2,3].filter(i => !t1.includes(i));
                let b1 = Math.min(scores[t1[0]], scores[t1[1]]), b2 = Math.min(scores[t2[0]], scores[t2[1]]);
                if (b1 < b2) { res[t1[0]].best += bPool; res[t1[1]].best += bPool; bPool = 0; }
                else if (b2 < b1) { res[t2[0]].best += bPool; res[t2[1]].best += bPool; bPool = 0; }
                else if (!cfg.bCarry) bPool = 0;
            }

            // 3. Scratch (å²ä¼°åƒå¹¾)
            if (cfg.scr) {
                if (cfg.sMode === 'all') {
                    for(let i=0; i<4; i++) for(let j=i+1; j<4; j++) {
                        if(scores[i] < scores[j]) { res[i].scr++; res[j].scr--; }
                        else if(scores[j] < scores[i]) { res[j].scr++; res[i].scr--; }
                    }
                } else {
                    document.querySelectorAll('.duel-row').forEach(row => {
                        const p1 = parseInt(row.querySelector('.scr-p1').value), p2 = parseInt(row.querySelector('.scr-p2').value);
                        const rec = parseInt(row.querySelector('.scr-rec').value), hList = row.querySelector('.scr-h').value.split(',').map(s=>s.trim());
                        if (p1 !== -1 && p2 !== -1) {
                            let n1 = scores[p1], n2 = scores[p2];
                            if (hList.includes(h.toString())) {
                                if (p1 === rec) n1 -= 1; else if (p2 === rec) n2 -= 1;
                            }
                            if (n1 < n2) { res[p1].scr++; res[p2].scr--; }
                            else if (n2 < n1) { res[p2].scr++; res[p1].scr--; }
                        }
                    });
                }
            }

            // 4. Skins
            if (cfg.skin) {
                skPool++;
                let min = Math.min(...scores);
                let wins = scores.map((s, idx) => s === min ? idx : -1).filter(idx => idx !== -1);
                if (wins.length === 1 && scores[wins[0]] <= cfg.skVal) { res[wins[0]].skins += skPool; skPool = 0; }
                else if (!cfg.skCarry) skPool = 0;
            }
        }

        const summary = document.getElementById('sumBody');
        summary.innerHTML = players.map((name, i) => `<tr>
            <td>${name}</td>
            <td class="${res[i].vegas>=0?'val-win':'val-lose'}">${res[i].vegas}</td>
            <td class="win">${res[i].best}</td>
            <td class="${res[i].scr>=0?'val-win':'val-lose'}">${res[i].scr}</td>
            <td class="win">${res[i].skins}</td>
            <td>${res[i].total}</td>
        </tr>`).join('');
    }

    // åˆå§‹åŒ–
    syncAll();
</script>
</body>
</html>
